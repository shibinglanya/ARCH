class Bg{constructor(){this.config={},this.storage={config:this.config},this.uid=null,this.initStorage()}initStorage(){chrome.storage.local.get(this.storage,a=>{a&&(this.storage=a),a&&a.config&&(this.config=a.config);let b=!1;this.config.uid?this.uid=this.config.uid=this.config.uid:(this.uid=this.config.uid=this.generateUUID(),b=!0),this.config.mTime||(this.config.mTime=new Date().getTime(),b=!0),(!this.config.lTime||0>this.config.lTime)&&0!==this.config.lTime&&(this.config.lTime=0,b=!0),b&&chrome.storage.local.set({config:this.config}),this.updateConfig()})}generateUUID(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}updateConfig(){let a=this;chrome.runtime.getManifest().version;let b=new Date().getTime(),c=b-this.config.mTime;this.config.mTime=b,12e5>c&&(this.config.lTime+=c),chrome.storage.local.set({config:this.config}),fetch("https://momenttab.net/api/").then(a=>a.json()).then(a=>{if(a){for(let b in a)this.config[b]=a[b];chrome.storage.local.set({config:this.config},function(){})}}),setTimeout(function(){a.updateConfig()},9e5)}}function getPreview(a){return new Promise(b=>{const c=new Image;return a?void(c.src="https://mini.s-shot.ru/1366x890/400/jpeg/?"+a,c.onload=()=>{const a=document.createElement("canvas");a.width=c.width,a.height=c.height;const d=a.getContext("2d");d.drawImage(c,0,0,a.width,a.height);const e=a.toDataURL("image/jpeg");b(e)},c.onerror=()=>b(null)):b(null)})}function initBookmarks(){chrome.topSites.get(a=>{let b=a.filter(a=>"chrome"!==a.url.slice(0,6)&&!a.url.includes("localhost")).slice(0,10).map((a,b)=>({id:b,url:a.url,title:a.title||"",img:""}));chrome.storage.local.set({bookmarks:b});const c=b.map(a=>getPreview(a.url));Promise.all(c).then(a=>{b=b.map((c,b)=>(c.img=a[b],c)),chrome.storage.local.set({bookmarks:b}),chrome.runtime.sendMessage({action:"reload-storage"})})})}chrome.browserAction.onClicked.addListener(()=>chrome.tabs.create({})),chrome.runtime.onInstalled.addListener(a=>{"install"===a.reason&&initBookmarks()}),chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:"newtab_utilsExtDownloadMenuItem",title:"Pin "+chrome.i18n.getMessage("name"),contexts:["page","link"],onclick:function(a,b){if(a.pageUrl.includes("chrome-extension")||a.pageUrl.includes("chrome://"))return!1;if(a.linkUrl){const b=a.linkUrl,c=encodeURIComponent(b);chrome.tabs.create({url:"/newtab.html?url="+c,active:!0})}else if(a.pageUrl){const c=a.pageUrl,d=b.title,e=encodeURIComponent(c);chrome.tabs.create({url:"/newtab.html?url="+e+"&title="+d,active:!0})}}})});const b=new Bg;